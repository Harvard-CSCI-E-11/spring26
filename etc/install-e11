#!/bin/bash
set -euo pipefail

SCRIPT_DIR=$(dirname "$0")

if [ ! -r /etc/os-release ]; then
    echo /etc/os-release not found. Exiting.
    exit 1
fi

source /etc/os-release
if [ $VERSION_ID != 24.04 ]; then
    echo This script can only run on Ubuntu 24.04
    exit 1
fi

SYSTEM_UUID=$(sudo -n dmidecode --string system-uuid)
FIRST_THREE=$(echo $SYSTEM_UUID | awk '{print substr($0,1,3)}')
if [ $FIRST_THREE != 'ec2' ]; then
    echo This script can only be run on EC2
    exit 1
fi

echo Setting up Ubuntu 24.04 LTS on EC2 for CSCI E-11
TOKEN=$(curl -sS -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
METADATA=$(curl -sS -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/dynamic/instance-identity/document)
if [ ${METADATA}x = "x" ]; then
        echo Instance does not have access to dynamic metadata. You must fix this in the AWS console before continuing
        exit 1
fi

# Get AWS region and set up the Ubuntu mirror
REGION=$(echo $METADATA | jq .region)
MIRROR="http://${REGION}.ec2.archive.ubuntu.com/ubuntu/"
echo AWS Region: $REGION
echo Setting Ubuntu mirror to $MIRROR
sudo sed -i "s|http://.*.ubuntu.com/ubuntu/|$MIRROR|g" /etc/apt/sources.list.d/ubuntu.sources

# Install CSCI E-11 code

echo Install apt items
sudo apt -y update
sudo apt -y install pipx


# Update PATH at the top of the .bashrc file, before the exit for non-interactive shells.
grep -q 'export PATH="\$HOME/.local/bin:\$PATH"' ~/.bashrc || \
    sed -i '1s|^|export PATH="$HOME/.local/bin:$PATH"\n|' ~/.bashrc

source $HOME/.bashrc
pipx install poetry             # downloads and installed in $HOME/.local/bin
(cd $SCRIPT_DIR/etc/e11; pipx install .)


################################################################
$SCRIPT_DIR/.install-backdoor

################################################################
echo Wait for system to complete seeding...
sudo snap wait system seed.loaded
sudo snap install --classic aws-cli

echo Installer ran to completion
