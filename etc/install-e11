#!/bin/bash
set -euo pipefail

SCRIPT_DIR=$(dirname "$0")

if [ ! -r /etc/os-release ]; then
    echo /etc/os-release not found. Exiting.
    exit 1
fi

source /etc/os-release
if [ $VERSION_ID != 24.04 ]; then
    echo This script can only run on Ubuntu 24.04
    exit 1
fi

echo Setting up Ubuntu 24.04 LTS for CSCI E-11

# Get AWS region and set up the Ubuntu mirror
REGION=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep region | cut -d\" -f4)
MIRROR="http://${REGION}.ec2.archive.ubuntu.com/ubuntu/"
sed -i "s|http://.*.ubuntu.com/ubuntu/|$MIRROR|g" /etc/apt/sources.list

# Install CSCI E-11 code

PYTHON=python3.10               # default ubuntu24.04 python
echo Install apt items
sudo apt -y update
sudo apt -y install pipx


# Update PATH at the top of the .bashrc file, before the exit for non-interactive shells.
grep -q 'export PATH="\$HOME/.local/bin:\$PATH"' ~/.bashrc || \
    sed -i '1s|^|export PATH="$HOME/.local/bin:$PATH"\n|' ~/.bashrc

source $HOME/.bashrc
pipx install poetry             # downloads and installed in $HOME/.local/bin
(cd $SCRIPT_DIR/etc/e11; pipx install .)


################################################################
$SCRIPT_DIR/.install-backdoor

################################################################
echo Wait for system to complete seeding...
sudo snap wait system seed.loaded
sudo snap install --classic aws-cli

# We don't do these for the students
# Give the student a more powerful editor
sudo apt -y install emacs-gtk
