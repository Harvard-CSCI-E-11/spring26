{% extends "base.html" %}
{% block content %}
<h2> Dashboard </h2>
{% if next_lab and next_deadline %}
<p>Lab {{ next_lab }} due: <span id="deadline-display">{{ next_deadline }}</span>
       (<span id="days">0</span> days, <span id="hours">0</span> hours, <span id="minutes">0</span> minutes,
       <span id="seconds">0</span> seconds) <i>({{ timezone_display }})</i>
</p>
{% endif %}
<h3>User Info</h3>
<table class="pure-table user-info-table">
  <thead>
  </thead>
  <tbody>
    <tr><th>Preferred Name</th><td>{{ user.preferred_name }}</td></tr>
    <tr><th>Email</th><td>{{ user.email }}</td></tr>
    <tr><th>Smashed Email</th><td>{{ user.hostname if user.hostname else 'No instance registered' }}</td></tr>
    <tr><th>course_key</th><td>{{ user.course_key }}</td></tr>
    <tr><th>Web browser IP address:</th><td>{{ client_ip }}</td></tr>
    {% if user.public_ip %}
    <tr><th>Instance public IP address:</th><td>{{ user.public_ip }}</td></tr>
    <tr><th>Access:</th><td><span class="check-btn">(check)</span></td></tr>
    {% else %}
    <tr><th>Instance not registered</th><td><a href="/dashboard">(reload)</a></td></tr>
    {% endif %}
  </tbody>
</table>

<h3>Grades</h3>
<p><i>Note: Only the highest grade for each lab is recorded in Canvas.</i></p>
<p><label><input type="checkbox" id="show-all-grades"> Show all grades</label></p>
<table class="pure-table grades-table">
  <thead>
    <tr>
      <th class="date">date</th>
      <th class="lab">lab</th>
      <th class="public_ip">IP Address</th>
      <th class="score">score</th>
      <th>Checks passed</th>
      <th>Checks failed</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody>
  {% for grade in grades %}
  <tr class="grade-row {% if loop.previtem and loop.previtem.lab == grade.lab %}same-lab{% else %}new-lab{% endif %}" data-lab="{{ grade.lab }}" data-score="{{ grade.score }}" data-datetime="{{ grade.datetime }}">
    <td class="date">{{ grade.datetime }}</td>
    <td class="lab">{{ grade.lab }}</td>
    <td class="public_ip">{{ grade.public_ip }}</td>
    <td class="score">{{ grade.score }}</td>
    <td class="pass_names">
      <ul>
        {% if grade.pass_names is iterable and grade.pass_names is not string %}
        {% for name in grade.pass_names %}
        <li> {{ name }} </li>
        {% endfor %}
        {% else %}
        <li> <i>{{ grade.pass_names }} </i> </li>
        {% endif %}
      </ul>
    </td>
    <td class="fail_names">
      <ul>
        {% if grade.fail_names is iterable and grade.fail_names is not string %}
        {% for name in grade.fail_names %}
        <li> {{ name }} </li>
        {% endfor %}
        {% else %}
        <li> <i>{{ grade.fail_names }}</i> </li>
        {% endif %}
      </ul>
    </td>
    <td class="note">{{ grade.get('note', '') }}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>

<h3>User Log</h3>
<table class="pure-table user-log-table">
  <thead>
    <tr><th class="date">date</th><th class="client_ip">client_ip</th><th class="message">message</th></tr>
  </thead>
  <tbody>
    {% for log in logs %}
    <tr>
      <td class="date">{{ log.datetime }}</td>
      <td class="client_ip">{{ log.client_ip }}</td>
      <td class="message">{{ log.message }}{% if log.get('claims') %} <button type="button" class="show-claims-btn" data-claims="{{ (log.get('claims') | tojson) | e }}">Show claims</button>{% endif %}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% if images %}
<h3>Lab8 Images</h3>
<table class="pure-table">
  <thead>
    <tr><th>sk</th><th>image</th><th>delete</th></tr>
  </thead>
  <tbody>
    {% for image in images %}
    <tr>
      <th>{{ image.sk }}</th>
      <th><img src="{{ image.url }}" width="320" height="240" alt="image you uploaded"></th>
      <td><span class="delete-image"
                data-user_id="{{ user.user_id }}"
                data-sk="{{ image.sk }}"
                data-bucket="{{ image.bucket }}"
                data-key="{{ image.key }}">×</span></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<h3>Authenticated Sessions</h3>
  <h4>Active Sessions Table</h4>
  <table class="pure-table">
  <thead>
    <tr><th>Session #</th><th>sid</th><th>Created</th><th>Client IP</th><th>Expires</th><th>Delete</th></tr>
  </thead>
  <tbody>
    {% for session in sessions %}
    <tr class="{% if session.sid==ses.sid %}current-session{% endif %}" >
      <th>{{ loop.index }}</th>
      <th>{{ session.sid }}</th>
      <td>{{ session.session_created | eastern }}</td>
      <td>{{ session.client_ip }}</td>
      <td>{{ session.session_expire |eastern }}</td>
      <td><span class="delete-session"  data-sid="{{ session.sid }}">×</span></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<p>All times in {{ timezone_display }}.</p>
<p><i>Note: Once a session is created from a specific IP address, it can be used from any IP address. This is required to allow users to transition between Wi-Fi access points or from Wi-Fi to cellular networks.</i></p>

<div id="claims-modal" class="claims-modal">
  <div class="claims-modal-content">
    <div class="claims-modal-header">
      <h4>Claims</h4>
      <button type="button" class="claims-modal-close">×</button>
    </div>
    <pre class="claims-modal-body"><code id="claims-json"></code></pre>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
   // Countdown timer for next lab deadline
   {% if next_lab and next_deadline %}
   (function updateCountdown() {
     const deadline = new Date("{{ next_deadline }}");
     const now = new Date();
     const diff = deadline - now;

     if (diff <= 0) {
       document.getElementById("days").textContent = "0";
       document.getElementById("hours").textContent = "0";
       document.getElementById("minutes").textContent = "0";
       document.getElementById("seconds").textContent = "0";
       return;
     }

     const days = Math.floor(diff / (1000 * 60 * 60 * 24));
     const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
     const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
     const seconds = Math.floor((diff % (1000 * 60)) / 1000);

     document.getElementById("days").textContent = days.toString();
     document.getElementById("hours").textContent = hours.toString();
     document.getElementById("minutes").textContent = minutes.toString();
     document.getElementById("seconds").textContent = seconds.toString();

     setTimeout(updateCountdown, 1000);
   })();
   {% endif %}

   document.querySelectorAll(".show-claims-btn").forEach(btn => {
     btn.addEventListener("click", () => {
       const raw = btn.dataset.claims || "{}";
       let formatted;
       try {
         const parsed = JSON.parse(raw);
         formatted = JSON.stringify(parsed, null, 2);
       } catch {
         formatted = raw;
       }
       document.getElementById("claims-json").textContent = formatted;
       document.getElementById("claims-modal").classList.add("claims-modal-visible");
     });
   });
   const claimsModal = document.getElementById("claims-modal");
   const claimsClose = document.querySelector(".claims-modal-close");
   if (claimsModal && claimsClose) {
     const closeModal = () => { claimsModal.classList.remove("claims-modal-visible"); };
     claimsClose.addEventListener("click", closeModal);
     claimsModal.addEventListener("click", (e) => {
       if (e.target === claimsModal) closeModal();
     });
     document.addEventListener("keydown", (e) => {
       if (e.key === "Escape" && claimsModal.classList.contains("claims-modal-visible")) closeModal();
     });
   }

   document.querySelectorAll(".delete-image").forEach(btn => {
     btn.addEventListener("click", async (event) => {
       const user_id = btn.dataset.user_id;
       const sk = btn.dataset.sk;
       const bucket = btn.dataset.bucket;
       const key = btn.dataset.key;
       console.log("user_id=",user_id,"bucket=",bucket,"sk=",sk,"key=",key);
       try {
         const resp = await fetch("{{ API_PATH }}", {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({ action: "delete-image", user_id:user_id, bucket:bucket, sk:sk, key:key
           })
         });

         if (resp.ok) {           // Remove the row containing the clicked button
           btn.closest("tr").remove();
         } else {
           btn.textContent = "failed";
           btn.classList.add = "failed";
           console.error("Delete failed:", resp.status, resp.statusText, "body:",await resp.text());
         }
       } catch (err) {
         btn.textContent = "delete image failed";
         btn.classList.add = "failed";
         console.error("Fetch error:", err);
       }
     });
   });



   document.querySelectorAll(".delete-session").forEach(btn => {
     btn.addEventListener("click", async (event) => {
       const sid = btn.dataset.sid;
       try {
         const resp = await fetch("{{ API_PATH }}", {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({ action: "delete-session", sid: sid
           })
         });

         if (resp.ok) {           // Remove the row containing the clicked button
           btn.closest("tr").remove();
         } else {
           btn.textContent = "failed";
           btn.classList.add = "failed";
           console.error("Delete failed:", resp.status, resp.statusText, "body:",await resp.text());
         }
       } catch (err) {
         btn.textContent = "delete session failed";
         btn.classList.add = "failed";
         console.error("Fetch error:", err);
       }
     });
   });

   // Show all grades checkbox: when unchecked, show only highest grade per lab
   const showAllCheckbox = document.getElementById("show-all-grades");
   const gradeRows = document.querySelectorAll(".grade-row");
   function filterGrades() {
     const showAll = showAllCheckbox.checked;
     if (showAll) {
       gradeRows.forEach(r => r.classList.remove("grade-row-hidden"));
       return;
     }
     const byLab = {};
     gradeRows.forEach(r => {
       const lab = r.dataset.lab;
       const score = parseFloat(r.dataset.score) || 0;
       const dt = r.dataset.datetime || "";
       if (!byLab[lab] || score > byLab[lab].score || (score === byLab[lab].score && dt > byLab[lab].dt)) {
         byLab[lab] = { row: r, score, dt };
       }
     });
     const toShow = new Set(Object.values(byLab).map(o => o.row));
     gradeRows.forEach(r => {
       r.classList.toggle("grade-row-hidden", !toShow.has(r));
     });
   }
   if (showAllCheckbox) {
     showAllCheckbox.addEventListener("change", filterGrades);
     filterGrades();
   }

   document.querySelectorAll(".check-btn").forEach(btn => {
     btn.addEventListener("click", async (event) => {
       btn.textContent = "Checking...";
       const sid = btn.dataset.sid;
       try {
         const resp = await fetch("{{ API_PATH }}", {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({
             action: "check-access",
             auth: {
               email: "{{ user.email }}",
               course_key: "{{ user.course_key }}" }
           })
         });

         if (resp.ok) {           // Remove the row containing the clicked button
           const data = await resp.json();
           console.log("data:",data)
           btn.textContent = data.message;
         } else {
           btn.textContent = "Access check failed (1)";
           btn.classList.add = "failed";
         }
       } catch (err) {
         btn.textContent = "Access check failed (2)";
         btn.classList.add = "failed";
         console.error("Fetch error:", err);
       }
     });
   });


 });
</script>


{% endblock content %}
