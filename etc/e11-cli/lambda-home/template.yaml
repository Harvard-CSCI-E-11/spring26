# HOW TO DEPLOY WITH SAM (creates samconfig.toml on first guided deploy):
#   sam build
#   sam deploy --guided --profile fas
#
# This template is parameterized for 'prod' and 'stage' environments.
# The environment is controlled by the 'EnvironmentName' parameter,
# which should be set in your samconfig.toml file.
#
# Example (samconfig-stage.toml):
#   [default.deploy.parameters]
#   stack_name = "home-app-stage"
#   EnvironmentName = "stage"
#   ...
#
# Example (samconfig-prod.toml for prod):
#   [default.deploy.parameters]
#   stack_name = "home-app"
#   EnvironmentName = "prod"
#   ...

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "CSCI E-11 Home Lambda (Unified Prod/Stage)"

Mappings:
  EnvConfig:
    prod:
      DomainName: "csci-e-11.org"
      StageName: "prod"
      Description: "e11 home Lambda with custom domain (csci-e-11.org)"
      CustomDomainUrl: "https://csci-e-11.org/"
    stage:
      DomainName: "stage.csci-e-11.org"
      StageName: "stage"
      Description: "e11 home Lambda staging environment (stage.csci-e-11.org)"
      CustomDomainUrl: "https://stage.csci-e-11.org/"

Globals:
  Function:
    Architectures: [ arm64 ]
    Environment:
      Variables:
        LOG_LEVEL: !Ref LogLevel
        OIDC_SECRET_ID: !Ref OidcSecretId
        SSH_SECRET_ID: !Ref SshSecretId
        SQS_SECRET_ID: !Ref SqsSecretId
        USERS_TABLE_NAME: !Ref UsersTableName
        SESSIONS_TABLE_NAME: !Ref SessionsTable
        LEADERBOARD_TABLE_NAME: !Ref LeaderboardTableName
        PYTHONPATH: "/var/task/home_app/e11.whl"
        DEPLOYMENT_TIMESTAMP: !Ref DeploymentTimestamp
        IMAGE_BUCKET_NAME: !Ref ImageBucketName
        STAGE_NAME: !FindInMap [EnvConfig, !Ref EnvironmentName, StageName]
        SQS_QUEUE_URL: !Ref HomeQueue
        SQS_QUEUE_ARN: !GetAtt HomeQueue.Arn

Parameters:
  EnvironmentName:
    Type: String
    Default: stage
    AllowedValues: [prod, stage]
    Description: The deployment environment (prod or stage).
  ImageBucketName:
    Type: String
    Default: csci-e-11
  UsersTableName:
    Type: String
    Default: "e11-users"
    Description: DynamoDB table name for users
  HostedZoneId:
    Type: String
    Description: Route53 Hosted Zone ID for csci-e-11.org (e.g., Z0123456789ABCDEF)
  CertificateArn:
    Type: String
    Default: ""
    Description: (Optional) ACM Certificate ARN for the domain. Leave blank to auto-create.
  OidcSecretId:
    Type: String
    Description: Secrets Manager ARN for OIDC secrets (github-oidc)
  SshSecretId:
    Type: String
    Description: Secrets Manager ARN for SSH secrets (e11-ssh)
  SqsSecretId:
    Type: String
    Description: Secrets Manager ARN for SQS authentication secret
    Default: arn:aws:secretsmanager:us-east-1:586794483136:secret:sqs-auth-secret-CkrRul
  LogLevel:
    Type: String
    Default: INFO
    AllowedValues: [CRITICAL, ERROR, WARNING, INFO, DEBUG, NOTSET]
    Description: Default LOG_LEVEL environment value for the function
  DeploymentTimestamp:
    Type: String
    Description: UTC timestamp of when the application was deployed.
    Default: 'Not Set'
  LeaderboardTableName:
    Type: String
    Default: "Leaderboard"
    Description: DynamoDB table name for leaderboard

Conditions:
  CreateAcmCert: !Equals [!Ref CertificateArn, ""]

# Resources are things that the SAM creates
Resources:
  # Optional, auto-created ACM cert for the custom domain (regional, DNS validated)
  HomeCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: CreateAcmCert
    Properties:
      DomainName: !FindInMap [EnvConfig, !Ref EnvironmentName, DomainName]
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !FindInMap [EnvConfig, !Ref EnvironmentName, DomainName]
          HostedZoneId: !Ref HostedZoneId

  # HTTP API fronting the Lambda, bound to specified domain
  HomeHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: !FindInMap [EnvConfig, !Ref EnvironmentName, StageName]
      CorsConfiguration:
        AllowOrigins: ['*']
        AllowMethods: ['GET','POST','OPTIONS']
      Domain:
        DomainName: !FindInMap [EnvConfig, !Ref EnvironmentName, DomainName]
        CertificateArn: !If [CreateAcmCert, !Ref HomeCertificate, !Ref CertificateArn]
        Route53:
          HostedZoneId: !Ref HostedZoneId

  # Lambda function â€” JSON-only API (no Flask)
  E11HomeFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: python3.13
      BuildProperties:
        RequirementsFile: requirements.txt   # relative to CodeUri (src/)
    Properties:
      Runtime: python3.13
      CodeUri: src/
      Handler: home_app.home.lambda_handler
      Timeout: 60
      MemorySize: 256
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref LeaderboardTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable

        - Version: '2012-10-17'
          Statement:
            - Sid: SecretsGet
              Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource:
                - !Ref OidcSecretId
                - !Ref SshSecretId
                - !Ref SqsSecretId

            - Sid: AllowRoute53Changes
              Effect: Allow
              Action:
                - route53:ChangeResourceRecordSets
                - route53:ListResourceRecordSets
                - route53:GetChange
              Resource: "arn:aws:route53:::hostedzone/*"

            - Sid: AllowSES
              Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"

            - Sid: AccessExistingBucket
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
              Resource:
                - !Sub 'arn:aws:s3:::${ImageBucketName}'      # The Bucket itself
                - !Sub 'arn:aws:s3:::${ImageBucketName}/*'    # The Objects inside

            - Sid: HomeQueueRW
              Effect: Allow
              Action:
                - sqs:SendMessage
                - sqs:ReceiveMessage
                - sqs:GetQueueAttributes
                - sqs:ChangeMessageVisibility
              Resource: !GetAtt HomeQueue.Arn

      Events:
        AnyRoot:
          Type: HttpApi
          Properties:
            ApiId: !Ref HomeHttpApi
            Path: /
            Method: ANY
            PayloadFormatVersion: "2.0"
        AnyProxy:
          Type: HttpApi
          Properties:
            ApiId: !Ref HomeHttpApi
            Path: /{proxy+}
            Method: ANY
            PayloadFormatVersion: "2.0"
        Heartbeat:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
            Input: '{"action":"heartbeat"}'
        FileUpload:
          Type: EventBridgeRule
          Properties:
            Pattern:
              source:
                - aws.s3
              detail-type:
                - "Object Created"
              detail:
                bucket:
                  name:
                    - !Ref ImageBucketName
                object:
                  key:
                    - prefix: "images/"
        FromHomeQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt HomeQueue.Arn
            BatchSize: 1        # prevents batching
            MaximumBatchingWindowInSeconds: 2
            FunctionResponseTypes:
              - ReportBatchItemFailures


  # Sessions table holds the cookie sessions.
  # It's a "Resource", so it's created and owned by the Lambda. The users table is not!
  SessionsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      BillingMode: PAY_PER_REQUEST
      TableName: !Sub "${AWS::StackName}-sessions"
      AttributeDefinitions:
        - AttributeName: sid
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: sid
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      GlobalSecondaryIndexes:
        - IndexName: GSI_Email
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  # SQS is used to queue grading requests.
  # Dead Letter Queue is for messages that don't get processed
  HomeQueueDeadLetterQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      QueueName: !Sub "${AWS::StackName}-home-dlq"
      MessageRetentionPeriod: 1209600  # 14 days

  HomeQueue:
    Type: AWS::SQS::Queue
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      QueueName: !Sub "${AWS::StackName}-home-queue"
      VisibilityTimeout: 75            # must be > Lambda Timeout (60s)
      MessageRetentionPeriod: 3600     # 1 hour
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt HomeQueueDeadLetterQueue.Arn
        maxReceiveCount: 5

# This is what the script prints
Outputs:
  ApiId:
    Description: HTTP API ID
    Value: !Ref HomeHttpApi
  CustomDomainUrl:
    Description: Public base URL
    Value: !FindInMap [EnvConfig, !Ref EnvironmentName, CustomDomainUrl]
  HomeFunction:
    Description: Home Lambda function name
    Value: !Ref E11HomeFunction
  HostedZoneId:
    Description: Route53 Hosted Zone
    Value: !Ref HostedZoneId
  SessionsTableArn:
    Description: ARN for Sessions Table
    Value: !Sub "${SessionsTable.Arn}"
  HomeQueueUrl:
    Description: URL of the Home SQS queue
    Value: !Ref HomeQueue
  HomeQueueArn:
    Description: ARN of the Home SQS queue
    Value: !GetAtt HomeQueue.Arn
